<%
  # Currently defined path prefixes
  #
  _AREAS    = [''].concat(%w( inbox res projects users account publish search ))

  # Expands to a cycle that sets the "area" variable by
  # comparing "doc.request_path" with each one of the
  # defined path prefixes.
  #
  _GET_AREA = %(
    var areas = #{_AREAS.to_json}, area;

    for (i in areas)
      if (doc.request_path.indexOf('/' + areas[i]) > 0)
        area = areas[i] || 'homepage(/)';
  ).gsub(/\s+/x, ' ').strip
%>

_id     : '_design/basic'
language: 'javascript'
views   :
  by_user_and_timestamp:
    map : |
      function (doc) {                                        
        emit ([doc.user_id, doc._id], doc);                                                    
      }

  by_user_and_timestamp:
    map : |
      function (doc) {                                        
        emit ([doc.user_id, doc._id], doc);                                                    
      }

  res_count: |
    map: |
      function(doc) {
        if (doc.request_path.indexOf('res/') > 0) {
          emit(doc.request_path.split("/")[2], 1);
        }
      }
    reduce: |
      function(keys, values, rereduce) {
        return sum(values);
      }

  res_item_count:
    map: |
      function(doc) {
        if (doc.request_path.indexOf('res/') > 0) {
          var pieces = doc.request_path.split('/')
          if (pieces.length > 3)
            emit([pieces[2], pieces[3]], 1)
        }
    reduce: |
      function(keys, values, rereduce) {
         return sum(values);
      }

  user_res_count:
    map: |
      function(doc) {
        if (doc.request_path.indexOf('res/') != -1) {
          emit([doc.user_id, doc.request_path.split('/')[2]], 1);
        }
      }
    reduce: |
      function(keys, values, rereduce) {
        return sum(values);
      }

  user_area_count:
    map: |
      function(doc) {
        <%= _GET_AREA %>
        emit([doc.user_id, area], 1);
      }
    reduce: |
      function(keys, values, rereduce) {
        return sum(values);
      }

  area_count:
    map: |
      function(doc) {
        <%= _GET_AREA %>
        emit(area, 1);
      }
    reduce: |
      function(keys, values, rereduce) {
        return sum(values);
      }

  average_duration_of_path:
    map: |
      function(doc) {
        if (doc.duration)
          emit(doc.request_path, doc.duration);
        }
    reduce: |
      function(keys, values){
        return Math.round(sum(values) / values.length)
      }

  average_duration_of_area:
    map: |
      function(doc) {
        if (doc.duration) {
          <%= _GET_AREA %>
          emit(area, doc.duration);
        }
      }
    reduce: |
      function(keys, values){
        return Math.round(sum(values) / values.length)
      }

  by_user_timestamp_area:
    map: |
      function(doc) {
        <%= _GET_AREA %>
        emit([doc.user_id, doc._id, area], doc)
      }
