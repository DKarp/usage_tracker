<%
  # Currently defined path prefixes, in JS Regexp format
  #
  _AREAS_RE = '\/(' << %w( inbox res projects users account publish search ).join('|');

  # Expands to JS code that defines the "area" variable by
  # executing the _AREAS_RE regexp onto the "request_path"
  # property of the "doc" object.
  #
  _GET_AREA = %(
    var match = /#{_AREAS_RE}/.exec (doc.env.request_path);
    var area  = match ? match[1] : 'homepage(/)';
  ).gsub(/\s+/x, ' ').strip
%>

_id     : '_design/basic'
language: 'javascript'
version : '2010102503' # Format: YYYY MM DD VV
views   :
  by_user_and_timestamp:
    map : |
      function (doc) {                                        
        emit ([doc.user_id, doc._id], doc);                                                    
      }

  by_user_and_timestamp:
    map : |
      function (doc) {                                        
        if (doc.env)
          emit ([doc.user_id, doc._id], doc);
      }

  res_count: |
    map: |
      function(doc) {
        if (doc.env && doc.env.request_path.indexOf("res/") > 0)
          emit (doc.env.request_path.split("/")[2], 1);
      }
    reduce: |
      function(keys, values, rereduce) {
        return sum(values);
      }

  res_item_count:
    map: |
      function(doc) {
        if (doc.env && doc.env.request_path.indexOf('res/') > 0) {
          var pieces = doc.env.request_path.split('/')
          if (pieces.length > 3)
            emit([pieces[2], pieces[3]], 1)
        }
    reduce: |
      function(keys, values, rereduce) {
         return sum(values);
      }

  user_res_count:
    map: |
      function(doc) {
        if (doc.env && doc.env.request_path.indexOf('res/') != -1)
          emit([doc.user_id, doc.env.request_path.split('/')[2]], 1);
      }
    reduce: |
      function(keys, values, rereduce) {
        return sum(values);
      }

  user_area_count:
    map: |
      function(doc) {
        if (doc.env) {
          <%= _GET_AREA %>
          emit([doc.user_id, area], 1);
        }
      }
    reduce: |
      function(keys, values, rereduce) {
        return sum(values);
      }

  area_count:
    map: |
      function(doc) {
        if (doc.env) {
          <%= _GET_AREA %>
          emit(area, 1);
        }
      }
    reduce: |
      function(keys, values, rereduce) {
        return sum(values);
      }

  average_duration_of_path:
    map: |
      function(doc) {
        if (doc.duration)
          emit (doc.env.request_path, doc.duration);
        }
    reduce: |
      function(keys, values){
        return Math.round(sum(values) / values.length)
      }

  average_duration_of_area:
    map: |
      function(doc) {
        if (doc.duration) {
          <%= _GET_AREA %>
          emit(area, doc.duration);
        }
      }
    reduce: |
      function(keys, values){
        return Math.round(sum(values) / values.length)
      }

  by_user_timestamp_area:
    map: |
      function(doc) {
        if (doc.env) {
          <%= _GET_AREA %>
          emit([doc.user_id, doc._id, area], doc)
        }
      }
